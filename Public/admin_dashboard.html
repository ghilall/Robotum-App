<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yönetici Paneli</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.2/build/css/intlTelInput.min.css" />
  <link rel="stylesheet" href="admin/admin_dashboard.css" /> 
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>Yönetici Paneli</h2>
    </div>
    
    <div class="admin-info">
      <p><strong>Ad Soyad:</strong> <span id="userName">Yükleniyor...</span></p>
      <p><strong>Email:</strong> <span id="userEmail">Yükleniyor...</span></p>
      <p><strong>Telefon:</strong> <span id="userPhone">Yükleniyor...</span></p>
      <p><strong>Son Giriş:</strong> <span id="lastLogin">Yükleniyor...</span></p>
    </div>

    <div class="sidebar-menu">
      <div class="menu-item active" onclick="showSection('dashboard')">
        <i>📊</i>
        <span>Dashboard</span>
      </div>
      <div class="menu-item" onclick="showSection('guardians')">
        <i>👥</i>
        <span>Veli Yönetimi</span>
      </div>
      <div class="menu-item" onclick="showSection('students')">
        <i>🎓</i>
        <span>Öğrenci Yönetimi</span>
      </div>
      <div class="menu-item" onclick="showSection('teachers')">
        <i>👨‍🏫</i>
        <span>Öğretmen Yönetimi</span>
      </div>
      <div class="menu-item" onclick="showSection('courses')">
        <i>📚</i>
        <span>Kurs Yönetimi</span>
      </div>
    </div>

    <div class="sidebar-footer">
      <button class="logout-btn" id="logoutBtn">
        <i>🚪</i>
        <span>Çıkış Yap</span>
      </button>
    </div>
  </div>

  <!-- Mobile Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Top Header -->
    <header class="top-header">
      <div class="header-left">
        <button class="mobile-menu-toggle" onclick="toggleSidebar()">☰</button>
        <h1>Robotum Yönetim Sistemi</h1>
      </div>
      <div class="header-right">
        <input type="text" class="search-input" placeholder="Ara..." id="searchInput">
        <div class="admin-badge">
          <i>👤</i>
          <span>Admin</span>
        </div>
      </div>
    </header>

    <!-- Content Area -->
    <div class="content-area">
      <!-- Dashboard Section -->
      <div id="dashboard-section" class="section-content">
        <!-- Welcome Card -->
        <div class="welcome-card">
          <h1>Hoşgeldiniz Yönetici</h1>
          <p>Buradan sistem kullanıcılarını ve kursları yönetebilirsiniz.</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card" onclick="showSection('students')" style="cursor:pointer;">
            <div class="stat-number" id="totalStudents">-</div>
            <div class="stat-label">Toplam Öğrenci</div>
          </div>
          <div class="stat-card" onclick="showSection('guardians')" style="cursor:pointer;">
            <div class="stat-number" id="totalGuardians">-</div>
            <div class="stat-label">Toplam Veli</div>
          </div>
          <div class="stat-card" onclick="showSection('teachers')" style="cursor:pointer;">
            <div class="stat-number" id="totalTeachers">-</div>
            <div class="stat-label">Toplam Öğretmen</div>
          </div>
          <div class="stat-card" onclick="showSection('courses')" style="cursor:pointer;">
            <div class="stat-number" id="totalCourses">-</div>
            <div class="stat-label">Aktif Kurslar</div>
          </div>
        </div>
      </div>

      <!-- Guardians Section -->
      <div id="guardians-section" class="management-section" style="display: none;">
        <div class="section-header">
          <h2>Veli Yönetimi</h2>
        </div>
        <div class="section-content">
          <div class="action-buttons">
            <button class="action-btn" id="openGuardianModalBtn" type="button">
              <i>➕</i>
              <span>Veli Ekle</span>
            </button>
            <button class="action-btn secondary" id="toggleGuardianActivePassiveBtn" type="button">
              <i>🔄</i>
              <span id="toggleGuardianActivePassiveBtnText">Pasif Velileri Göster</span>
            </button>
          </div>
          
          <!-- Search Bar -->
          <div class="search-container">
            <div class="search-input-group">
              <label for="guardianNameSearch">Veli Adı</label>
              <input type="text" id="guardianNameSearch" class="search-input-field" placeholder="Ad veya soyad ara...">
            </div>
            <div class="search-input-group">
              <label for="guardianPhoneSearch">Telefon</label>
              <input type="text" id="guardianPhoneSearch" class="search-input-field" placeholder="Telefon numarası ara...">
            </div>
            <div class="search-input-group">
              <label for="studentNameSearch">Öğrenci Adı</label>
              <input type="text" id="studentNameSearch" class="search-input-field" placeholder="Öğrenci adı ara...">
            </div>
            <div class="search-buttons">
              <button class="search-btn" onclick="searchGuardians()">
                🔍 Ara
              </button>
              <button class="clear-btn" onclick="clearGuardianSearch()">
                🗑️ Temizle
              </button>
            </div>
          </div>
          
          <div id="guardianSearchResults" style="display: none;"></div>
          
          <div class="guardian-list-container" id="guardianListContainer">
            <div class="loading">Veli listesi yükleniyor...</div>
          </div>
        </div>
      </div>

      <!-- Students Section -->
      <div id="students-section" class="management-section" style="display: none;">
        <div class="section-header">
          <h2>Öğrenci Yönetimi</h2>
        </div>
        <div class="section-content">
          <div class="action-buttons">
            <button class="action-btn" id="openStudentModalBtn" type="button">
              <i>➕</i>
              <span>Öğrenci Ekle</span>
            </button>
            <button class="action-btn secondary" id="toggleStudentActivePassiveBtn" type="button">
              <i>🔄</i>
              <span id="toggleStudentActivePassiveBtnText">Pasif Öğrencileri Göster</span>
            </button>
          </div>
          
          <!-- Search Bar -->
          <div class="search-container">
            <div class="search-input-group">
              <label for="categorySearch">Kategori</label>
              <select id="categorySearch" class="search-input-field">
                <option value="">Tüm kategoriler</option>
              </select>
            </div>
            <div class="search-input-group">
              <label for="courseSearch">Kurs</label>
              <select id="courseSearch" class="search-input-field">
                <option value="">Tüm kurslar</option>
              </select>
            </div>
            <div class="search-input-group">
              <label for="daySearch">Gün</label>
              <select id="daySearch" class="search-input-field">
                <option value="">Tüm günler</option>
                <option value="Pazartesi">Pazartesi</option>
                <option value="Salı">Salı</option>
                <option value="Çarşamba">Çarşamba</option>
                <option value="Perşembe">Perşembe</option>
                <option value="Cuma">Cuma</option>
                <option value="Cumartesi">Cumartesi</option>
                <option value="Pazar">Pazar</option>
              </select>
            </div>
            <div class="search-input-group">
              <label for="nameSearch">Öğrenci Adı</label>
              <input type="text" id="nameSearch" class="search-input-field" placeholder="Ad veya soyad ara...">
            </div>
            <div class="search-buttons">
              <button class="search-btn" onclick="searchStudents()">
                🔍 Ara
              </button>
              <button class="clear-btn" onclick="clearSearch()">
                🗑️ Temizle
              </button>
            </div>
          </div>
          
          <div id="searchResults" style="display: none;"></div>
          
          <div class="student-list-container" id="studentListContainer">
            <div class="loading">Öğrenci listesi yükleniyor...</div>
          </div>
        </div>
      </div>

      <!-- Teachers Section -->
      <div id="teachers-section" class="management-section" style="display: none;">
        <div class="section-header">
          <h2>Öğretmen Yönetimi</h2>
        </div>
        <div class="section-content">
          <div class="action-buttons">
            <button class="action-btn" id="openTeacherModalBtn" type="button">
              <i>➕</i>
              <span>Öğretmen Ekle</span>
            </button>
            <button class="action-btn secondary" id="toggleTeacherActivePassiveBtn" type="button">
              <i>🔄</i>
              <span id="toggleTeacherActivePassiveBtnText">Pasif Öğretmenleri Göster</span>
            </button>
            <a href="teacher_assignments.html" class="action-btn secondary">
              <i>📅</i>
              <span>Öğretmen Atamaları</span>
            </a>
          </div>
          
          <!-- Search Bar -->
          <div class="search-container">
            <div class="search-input-group">
              <label for="teacherNameSearch">Öğretmen Adı</label>
              <input type="text" id="teacherNameSearch" class="search-input-field" placeholder="Ad veya soyad ara...">
            </div>
            <div class="search-input-group">
              <label for="teacherCategorySearch">Kategori</label>
              <select id="teacherCategorySearch" class="search-input-field">
                <option value="">Tüm kategoriler</option>
              </select>
            </div>
            <div class="search-input-group">
              <label for="teacherExperienceSearch">Deneyim</label>
              <select id="teacherExperienceSearch" class="search-input-field">
                <option value="">Tüm deneyim seviyeleri</option>
                <option value="Öğretmen">Öğretmen</option>
                <option value="Yardımcı">Yardımcı</option>
                <option value="Stajyer">Stajyer</option>
              </select>
            </div>
            <div class="search-buttons">
              <button class="search-btn" onclick="searchTeachers()">
                🔍 Ara
              </button>
              <button class="clear-btn" onclick="clearTeacherSearch()">
                🗑️ Temizle
              </button>
            </div>
          </div>
          
          <div id="teacherSearchResults" style="display: none;"></div>
          
          <div class="teacher-list-container" id="teacherListContainer">
            <div class="loading">Öğretmen listesi yükleniyor...</div>
          </div>
        </div>
      </div>

      <!-- Courses Section -->
      <div id="courses-section" class="management-section" style="display: none;">
        <div class="section-header">
          <h2>Kurs Yönetimi</h2>
        </div>
        <div class="section-content">
          <div class="action-buttons">
            <a href="add_course.html" class="action-btn">
              <i>➕</i>
              <span>Kurs Ekle</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Öğrenci Kayıt Modalı -->
  <div id="studentModal" class="modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); justify-content:center; align-items:center;">
    <div class="registration-container" style="position:relative; margin:auto;">
      <button id="closeStudentModalBtn" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
      <h1>Öğrenci Kayıt Formu</h1>
      <form id="studentRegistrationForm">
        <label for="firstName">Ad</label>
        <input type="text" id="firstName" name="firstName" required />
        <label for="lastName">Soyad</label>
        <input type="text" id="lastName" name="lastName" required />
        <label for="birthDate">Doğum Tarihi</label>
        <input type="date" id="birthDate" name="birthDate" required />
        <label for="categoryFilter">Kategori (opsiyonel)</label>
        <select id="categoryFilter">
          <option value="">Tümü</option>
        </select>
        <label for="levelFilter">Seviye (opsiyonel)</label>
        <select id="levelFilter">
          <option value="">Tümü</option>
        </select>
        <label for="programDay">Gün</label>
        <select id="programDay" name="programDay" required>
          <option value="">Gün seçiniz</option>
          <option value="Pazartesi">Pazartesi</option>
          <option value="Salı">Salı</option>
          <option value="Çarşamba">Çarşamba</option>
          <option value="Perşembe">Perşembe</option>
          <option value="Cuma">Cuma</option>
          <option value="Cumartesi">Cumartesi</option>
          <option value="Pazar">Pazar</option>
        </select>
        <label for="courseId">Kurs</label>
        <select id="courseId" name="courseId" required>
          <option value="">Yükleniyor...</option>
        </select>
        <label for="programId">Program Saati</label>
        <select id="programId" name="programId" required>
          <option value="">Saat seçiniz</option>
        </select>
        <label for="guardianSearch">Veli Ara</label>
        <input type="text" id="guardianSearch" placeholder="İsimle ara..." autocomplete="off" />
        <div id="guardianResults"></div>
        <input type="hidden" id="guardianId" name="guardianId" required />
        <button type="submit">Kaydı Tamamla</button>
      </form>
    </div>
  </div>

  <!-- Veli Kayıt Modalı -->
  <div id="guardianModal" class="modal" style="display:none;">
    <div class="registration-container" style="position:relative; margin:auto;">
      <button id="closeGuardianModalBtn" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
      <h1 style="text-align:center;">Veli Ekle</h1>
      <form id="registerGuardianForm">
        <div class="row" style="display:flex; gap:20px; margin-bottom:15px; flex-wrap:wrap;">
          <div class="half" style="flex:1; min-width:280px;">
            <label for="guardianFirstName">Ad:</label>
            <input type="text" id="guardianFirstName" name="firstName" required />
          </div>
          <div class="half" style="flex:1; min-width:280px;">
            <label for="guardianLastName">Soy Ad:</label>
            <input type="text" id="guardianLastName" name="lastName" required />
          </div>
        </div>
        <div class="row" style="display:flex; gap:20px; margin-bottom:15px; flex-wrap:wrap;">
          <div class="half" style="flex:1; min-width:280px;">
            <label for="guardianPhone">Telefon Numarası:</label>
            <input type="tel" id="guardianPhone" name="phone" required placeholder="555 555 55 55" />
            <div id="guardianPhoneError" class="error" style="display:none; color:red; font-size:small; margin-bottom:15px;">Geçersiz telefon numarası.</div>
          </div>
          <div class="half" style="flex:1; min-width:280px;">
            <label for="guardianEmail">Email Adresi:</label>
            <input type="email" id="guardianEmail" name="email" required />
            <div id="guardianEmailError" class="error" style="display:none; color:red; font-size:small; margin-bottom:15px;">Bu email adresi ile bir hesap bulunuyor.</div>
          </div>
        </div>
        <div class="row" style="display:flex; gap:20px; margin-bottom:15px; flex-wrap:wrap;">
          <div class="password-wrapper" style="flex:1; min-width:280px;">
            <label for="guardianPassword">Şifre:</label>
            <div class="password-input-container" style="display:flex; align-items:center; border:1.5px solid #ccc; border-radius:5px; overflow:hidden; height:48px;">
              <input type="password" id="guardianPassword" name="password" required style="flex:1; border:none; padding:12px; font-size:16px; outline:none; box-sizing:border-box;" />
              <button type="button" class="togglePassword">Göster</button>
            </div>
          </div>
          <div class="password-wrapper" style="flex:1; min-width:280px;">
            <label for="guardianConfirmPassword">Şifre (Tekrar):</label>
            <div class="password-input-container" style="display:flex; align-items:center; border:1.5px solid #ccc; border-radius:5px; overflow:hidden; height:48px;">
              <input type="password" id="guardianConfirmPassword" name="confirmPassword" required style="flex:1; border:none; padding:12px; font-size:16px; outline:none; box-sizing:border-box;" />
              <button type="button" class="togglePassword">Göster</button>
            </div>
          </div>
        </div>
        <div class="row" style="display:flex; gap:20px; margin-bottom:15px; flex-wrap:wrap;">
          <div class="half" style="flex:1; min-width:280px;">
            <label for="guardianOccupation">Meslek:</label>
            <select id="guardianOccupation" name="occupation" required>
              <option value="">Meslek Seçiniz</option>
              <option value="1">Öğretmen</option>
              <option value="2">İşçi</option>
              <option value="3">Mühendis</option>
              <option value="4">Polis</option>
              <option value="5">Asker</option>
              <option value="6">Avukat</option>
              <option value="7">Savcı</option>
              <option value="8">Doktor</option>
              <option value="9">Ev Hanımı</option>
              <option value="10">Veteriner Hekim</option>
              <option value="11">Hemşire</option>
              <option value="12">Diş Hekimi</option>
              <option value="13">İşletme Sahibi</option>
              <option value="14">Diğer</option>
            </select>
          </div>
        </div>
        <button type="submit">Veliyi Kaydet</button>
        <div id="guardianPasswordError" class="error" style="display:none; color:red; font-size:small; margin-bottom:15px;">Şifreler eşleşmiyor. Lütfen aynı şifreyi girin.</div>
        <div id="guardianRegisterError" class="error" style="display:none; color:red; font-size:small; margin-bottom:15px;">Kayıt başarısız oldu.</div>
      </form>
    </div>
  </div>

  <!-- Öğretmen Kayıt Modalı -->
  <div id="teacherModal" class="modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); justify-content:center; align-items:center;">
    <div class="registration-container" style="position:relative; margin:auto; max-width:800px; width:90vw; min-width:350px; background:white; padding:40px 30px; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,0.18); overflow-y:auto; max-height:95vh;">
      <button id="closeTeacherModalBtn" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:28px; cursor:pointer;">&times;</button>
      <h1 style="text-align:center; margin-bottom:24px;">Öğretmen Kayıt Formu</h1>
      <form id="registerTeacherForm">
        <div class="row" style="display:flex; gap:20px; margin-bottom:15px; flex-wrap:wrap;">
          <div class="half" style="flex:1; min-width:280px;">
            <label for="teacherFirstName">Ad:</label>
            <input type="text" id="teacherFirstName" name="firstName" required />
          </div>
          <div class="half" style="flex:1; min-width:280px;">
            <label for="teacherLastName">Soyad:</label>
            <input type="text" id="teacherLastName" name="lastName" required />
          </div>
        </div>
        <div class="row" style="display:flex; gap:20px; margin-bottom:15px; flex-wrap:wrap;">
          <div class="half" style="flex:1; min-width:280px;">
            <label for="teacherPhone">Telefon Numarası:</label>
            <input type="tel" id="teacherPhone" name="phone" required />
            <div id="teacherPhoneError" class="error" style="display:none; color:red; font-size:small; margin-bottom:15px;">Geçersiz telefon numarası.</div>
          </div>
          <div class="half" style="flex:1; min-width:280px;">
            <label for="teacherEmail">Email Adresi:</label>
            <input type="email" id="teacherEmail" name="email" required />
            <div id="teacherEmailError" class="error" style="display:none; color:red; font-size:small; margin-bottom:15px;">Bu email adresi ile bir hesap bulunuyor.</div>
          </div>
        </div>
        <div class="row" style="display:flex; gap:20px; margin-bottom:15px; flex-wrap:wrap;">
          <div class="half" style="flex:1; min-width:280px;">
            <label for="teacherPassword">Şifre:</label>
            <div class="password-input-container" style="display:flex; align-items:center; border:1.5px solid #ccc; border-radius:5px; overflow:hidden; height:48px;">
              <input type="password" id="teacherPassword" name="password" required style="flex:1; border:none; padding:12px; font-size:16px; outline:none; box-sizing:border-box;" />
              <button type="button" class="togglePassword">Göster</button>
            </div>
          </div>
          <div class="half" style="flex:1; min-width:280px;">
            <label for="teacherConfirmPassword">Şifre (Tekrar):</label>
            <div class="password-input-container" style="display:flex; align-items:center; border:1.5px solid #ccc; border-radius:5px; overflow:hidden; height:48px;">
              <input type="password" id="teacherConfirmPassword" name="confirmPassword" required style="flex:1; border:none; padding:12px; font-size:16px; outline:none; box-sizing:border-box;" />
              <button type="button" class="togglePassword">Göster</button>
            </div>
          </div>
        </div>
        <div class="row" style="display:flex; gap:20px; margin-bottom:15px; flex-wrap:wrap;">
          <div class="half" style="flex:1; min-width:280px;">
            <label for="teacherSalary">Maaş:</label>
            <input type="text" id="teacherSalary" name="salary" required />
          </div>
          <div class="half" style="flex:1; min-width:280px;">
            <label for="teacherSSN">TC / SGK No:</label>
            <input type="text" id="teacherSSN" name="socialSecurityNumber" required />
          </div>
        </div>
        <div class="row" style="display:flex; gap:20px; margin-bottom:15px; flex-wrap:wrap;">
          <div class="half" style="flex:1; min-width:280px;">
            <label for="teacherEmploymentType">Çalışma Türü:</label>
            <select id="teacherEmploymentType" name="employmentType" required>
              <option value="">Seçiniz</option>
              <option value="Tam Zamanlı">Tam Zamanlı</option>
              <option value="Yarı Zamanlı">Yarı Zamanlı</option>
            </select>
          </div>
          <div class="half" style="flex:1; min-width:280px;">
            <label for="teacherCategoryId">Kategori:</label>
            <select id="teacherCategoryId" name="categoryId" required>
              <option value="">Kategori Seçiniz</option>
              <option value="1">Robotik Kodlama</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
          </div>
        </div>
        <div class="row" style="display:flex; gap:20px; margin-bottom:15px; flex-wrap:wrap;">
          <div class="half" style="flex:1; min-width:280px;">
            <label for="teacherStartDate">Başlangıç Tarihi:</label>
            <input type="date" id="teacherStartDate" name="startDate" required />
          </div>
          <div class="half" style="flex:1; min-width:280px;">
            <label for="teacherEndDate">Bitiş Tarihi (opsiyonel):</label>
            <input type="date" id="teacherEndDate" name="endDate" />
          </div>
        </div>
        <div class="row" style="display:flex; gap:20px; margin-bottom:15px; flex-wrap:wrap;">
          <div class="half" style="flex:1; min-width:280px;">
            <label for="teacherExperience">Deneyim:</label>
            <select id="teacherExperience" name="experience" required>
              <option value="">Öğretmen deneyimi seçiniz</option>
              <option value="Öğretmen">Baş Öğretmen</option>
              <option value="Yardımcı">Yardımcı Öğretmen</option>
              <option value="Stajyer">Stajyer</option>
            </select>
          </div>
        </div>
        <button type="submit">Kayıt Et</button>
        <div id="teacherPasswordError" class="error" style="display:none; color:red; font-size:small; margin-bottom:15px;">Şifreler eşleşmiyor. Lütfen aynı şifreyi girin.</div>
        <div id="teacherRegisterError" class="error" style="display:none; color:red; font-size:small; margin-bottom:15px;">Kayıt başarısız oldu.</div>
      </form>
    </div>
  </div>

  <!-- Öğrenci Düzenle Modalı -->
  <div id="editStudentModal" class="modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); justify-content:center; align-items:center;">
    <div class="registration-container" style="position:relative; margin:auto;">
      <button id="closeEditStudentModalBtn" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
      <h1>Öğrenci Bilgilerini Düzenle</h1>
      <form id="editStudentForm">
        <label for="editFirstName">Ad</label>
        <input type="text" id="editFirstName" name="firstName" required />
        <label for="editLastName">Soyad</label>
        <input type="text" id="editLastName" name="lastName" required />
        <label for="editBirthDate">Doğum Tarihi</label>
        <input type="date" id="editBirthDate" name="birthDate" required />
        <!-- Add other editable attributes here as needed -->
        <button type="submit">Kaydet</button>
      </form>
    </div>
  </div>

  <!-- Kurs Değiştir Modalı -->
  <div id="changeCourseModal" class="modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); justify-content:center; align-items:center;">
    <div class="registration-container" style="position:relative; margin:auto;">
      <button id="closeChangeCourseModalBtn" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
      <div id="changeCourseStudentInfo" style="margin-bottom:16px; font-size:1.1em;"></div>
      <h1>Kurs ve Program Değiştir</h1>
      <form id="changeCourseForm">
        <label for="changeCategoryFilter">Kategori (opsiyonel)</label>
        <select id="changeCategoryFilter">
          <option value="">Tümü</option>
        </select>
        <label for="changeLevelFilter">Seviye (opsiyonel)</label>
        <select id="changeLevelFilter">
          <option value="">Tümü</option>
        </select>
        <label for="changeCourseId">Kurs</label>
        <select id="changeCourseId" name="courseId" required>
          <option value="">Yükleniyor...</option>
        </select>
        <label for="changeProgramDay">Gün</label>
        <select id="changeProgramDay" name="programDay" required>
          <option value="">Gün seçiniz</option>
          <option value="Pazartesi">Pazartesi</option>
          <option value="Salı">Salı</option>
          <option value="Çarşamba">Çarşamba</option>
          <option value="Perşembe">Perşembe</option>
          <option value="Cuma">Cuma</option>
          <option value="Cumartesi">Cumartesi</option>
          <option value="Pazar">Pazar</option>
        </select>
        <label for="changeProgramId">Program Saati</label>
        <select id="changeProgramId" name="programId" required>
          <option value="">Saat seçiniz</option>
        </select>
        <button type="submit">Kaydet</button>
      </form>
    </div>
  </div>

  <!-- Guardian Düzenle Modalı -->
  <div id="editGuardianModal" class="modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); justify-content:center; align-items:center;">
    <div class="registration-container" style="position:relative; margin:auto;">
      <button id="closeEditGuardianModalBtn" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
      <h1>Veli Bilgilerini Düzenle</h1>
      <form id="editGuardianForm">
        <label for="editGuardianFirstName">Ad</label>
        <input type="text" id="editGuardianFirstName" name="firstName" required />
        <label for="editGuardianLastName">Soyad</label>
        <input type="text" id="editGuardianLastName" name="lastName" required />
        <label for="editGuardianEmail">Email</label>
        <input type="email" id="editGuardianEmail" name="email" required />
        <label for="editGuardianPhone">Telefon</label>
        <input type="tel" id="editGuardianPhone" name="phone" required />
        <button type="submit">Kaydet</button>
      </form>
    </div>
  </div>

  <!-- intl-tel-input CDN -->
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.2/build/js/intlTelInput.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.2/build/js/utils.js"></script>

  <!-- Admin js dosyalarını çağır -->
  <script src="admin/admin_dashboard_main.js"></script>
  <script src="admin/admin_manage_courses.js"></script>
  <script src="admin/admin_manage_students.js"></script>
  <script src="admin/admin_manage_guardians.js"></script>
  <script src="admin/admin_manage_teachers.js"></script>

  <script>
    // --- DOM ELEMENTLERİNİ EN BAŞTA TANIMLA ---
    const openStudentModalBtn = document.getElementById('openStudentModalBtn');
    const studentModal = document.getElementById('studentModal');
    const closeStudentModalBtn = document.getElementById('closeStudentModalBtn');
    const form = document.getElementById('studentRegistrationForm');
    const openGuardianModalBtn = document.getElementById('openGuardianModalBtn');
    const guardianModal = document.getElementById('guardianModal');
    const closeGuardianModalBtn = document.getElementById('closeGuardianModalBtn');
    const openTeacherModalBtn = document.getElementById('openTeacherModalBtn');
    const teacherModal = document.getElementById('teacherModal');
    const closeTeacherModalBtn = document.getElementById('closeTeacherModalBtn');

    document.addEventListener('DOMContentLoaded', function() {
      loadUser();
      loadDashboardStats();
      showSection('dashboard');
      loadStudentList();
      window.allStudentsData = data.grouped;
      displayStudentList(data.grouped);
      loadSearchFilters();
      loadAllCourses();
      updateCourseOptions();
      displayStudentList(groupedStudents);
    });

    // Display student list grouped by course
    function displayStudentList(groupedStudents) {
      const container = document.getElementById('studentListContainer');
      
      if (!groupedStudents || Object.keys(groupedStudents).length === 0) {
        container.innerHTML = '<div class="no-students">Henüz öğrenci bulunmuyor.</div>';
        return;
      }

      let html = '';
      
      for (const courseName in groupedStudents) {
        const students = groupedStudents[courseName];
        html += `
          <div class="course-group">
            <div class="course-title">${courseName}</div>
        `;
        
        for (const studentId in students) {
          const student = students[studentId];
          let programText = '';
          
          if (student.program && student.program.length > 0) {
            programText = student.program
              .map(p => `${p.day}: ${p.start} - ${p.end} (${p.room})`)
              .join(', ');
          }
          
          html += `
            <div class="student-item">
              <div class="student-info">
                <div class="student-name">${student.firstName} ${student.lastName}</div>
                <div class="student-details">
                  Öğrenci ID: ${student.studentId}
                </div>
                ${programText ? `<div class="program-info">📅 ${programText}</div>` : ''}
              </div>
              <div class="student-actions">
                <button class="edit-btn" onclick="editStudent(${student.studentId})">
                  ✏️ Düzenle
                </button>
                <button class="change-course-btn" onclick="changeStudentCourse(${student.studentId})">🔄 Kurs Değiştir</button>
                <button class="delete-btn" onclick="deleteStudent(${student.studentId}, '${student.firstName} ${student.lastName}')">
                  ⏸️ Pasife Al
                </button>
              </div>
            </div>
          `;
        }
        html += '</div>';
      }
      container.innerHTML = html;
    }
    // Öğrenci düzenleme için global değişken
    let editingStudentId = null;

    // Mobile sidebar functions
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('open');
      overlay.classList.toggle('open');
    }

    function closeSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.remove('open');
      overlay.classList.remove('open');
    }

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      // Add search functionality here if needed
    });

    // Logout functionality (keeping your existing logic)
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('user');
      window.location.href = '/';
    });

    // Initialize
    loadDashboardStats();

    // Add event listeners for search inputs when DOM is loaded
    setTimeout(() => {
      const searchInputs = ['categorySearch', 'courseSearch', 'daySearch', 'nameSearch'];
      searchInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
          input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              searchStudents();
            }
          });
        }
      });
    }, 100);

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(e) {
      if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        if (!sidebar.contains(e.target) && !e.target.classList.contains('mobile-menu-toggle')) {
          closeSidebar();
        }
      }
    });

    // Student search logic moved to admin_manage_students.js

    // Passive user viewing functions
    function viewPassiveStudents() {
      window.open('/passive_students.html', '_blank', 'width=1200,height=800');
    }

    function viewPassiveGuardians() {
      window.open('/passive_guardians.html', '_blank', 'width=1200,height=800');
    }

    function viewPassiveTeachers() {
      window.open('/passive_teachers.html', '_blank', 'width=1200,height=800');
    }

    // Modal açma/kapama
    if (openStudentModalBtn && studentModal && closeStudentModalBtn) {
      openStudentModalBtn.addEventListener('click', () => {
        document.querySelector('#studentModal h1').textContent = 'Öğrenci Kayıt Formu';
        form.reset();
        form.guardianId.value = '';
        form.guardianSearch.value = '';
        studentModal.style.display = 'flex';
      });
      closeStudentModalBtn.addEventListener('click', () => {
        studentModal.style.display = 'none';
      });
      window.addEventListener('click', (e) => {
        if (e.target === studentModal) studentModal.style.display = 'none';
      });
    }
    // Veli Modal açma/kapama
    let guardianIti;
    if (openGuardianModalBtn && guardianModal && closeGuardianModalBtn) {
      openGuardianModalBtn.addEventListener('click', () => {
        guardianModal.style.display = 'flex';
        setTimeout(() => {
          const guardianPhoneInput = document.getElementById('guardianPhone');
          if (guardianPhoneInput) {
            if (guardianIti) guardianIti.destroy();
            guardianIti = window.intlTelInput(guardianPhoneInput, {
              initialCountry: 'tr',
              separateDialCode: true,
              nationalMode: true,
              autoPlaceholder: 'polite',
              formatOnDisplay: true,
              utilsScript: 'https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.2/build/js/utils.js'
            });
          }
        }, 0);
      });
      closeGuardianModalBtn.addEventListener('click', () => {
        guardianModal.style.display = 'none';
      });
      window.addEventListener('click', (e) => {
        if (e.target === guardianModal) guardianModal.style.display = 'none';
      });
    }
    // Veli kayıt formu scriptleri
    const guardianForm = document.getElementById('registerGuardianForm');
    const guardianPhoneError = document.getElementById('guardianPhoneError');
    guardianForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      guardianPhoneError.style.display = 'none';
      if (!guardianIti || !guardianIti.isValidNumber()) {
        guardianPhoneError.style.display = 'block';
        return;
      }
      // Diğer validasyonlar ve form submit işlemleri burada devam edecek
      // Telefon numarasını guardianIti.getNumber() ile alın
      const data = {
        firstName: guardianForm.guardianFirstName.value,
        lastName: guardianForm.guardianLastName.value,
        phone: guardianIti.getNumber(),
        email: guardianForm.guardianEmail.value,
        password: guardianForm.guardianPassword.value,
        confirmPassword: guardianForm.guardianConfirmPassword.value,
        occupation: guardianForm.guardianOccupation.value
      };
      try {
        const response = await fetch('/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await response.json();
        if (!response.ok) {
          if (result.error && result.error.toLowerCase().includes('email')) {
            guardianEmailError.style.display = 'block';
          } else {
            guardianRegisterError.textContent = result.error || 'Kayıt başarısız oldu.';
            guardianRegisterError.style.display = 'block';
          }
        } else {
          guardianModal.style.display = 'none';
          // window.location.href = '/register_success.html';
          // İsteğe bağlı: veli listesini burada güncelleyebilirsiniz
        }
      } catch (err) {
        guardianRegisterError.textContent = 'Bağlantı hatası. Lütfen daha sonra tekrar deneyin.';
        guardianRegisterError.style.display = 'block';
      }
    });
    document.querySelectorAll('#guardianModal .togglePassword').forEach(button => {
      button.addEventListener('click', () => {
        const input = button.previousElementSibling;
        if (input.type === "password") {
          input.type = "text";
          button.textContent = "Gizle";
        } else {
          input.type = "password";
          button.textContent = "Göster";
        }
      });
    });

    // Öğretmen Modal açma/kapama ve JS
    let teacherIti;
    if (openTeacherModalBtn && teacherModal && closeTeacherModalBtn) {
      openTeacherModalBtn.addEventListener('click', () => {
        teacherModal.style.display = 'flex';
        setTimeout(() => {
          const teacherPhoneInput = document.getElementById('teacherPhone');
          if (teacherPhoneInput) {
            if (teacherIti) teacherIti.destroy();
            teacherIti = window.intlTelInput(teacherPhoneInput, {
              initialCountry: 'tr',
              separateDialCode: true,
              nationalMode: true,
              autoPlaceholder: 'polite',
              formatOnDisplay: true,
              utilsScript: 'https://cdn.jsdelivr.net/npm/intl-tel-input@19.5.2/build/js/utils.js'
            });
          }
        }, 0);
      });
      closeTeacherModalBtn.addEventListener('click', () => {
        teacherModal.style.display = 'none';
      });
      window.addEventListener('click', (e) => {
        if (e.target === teacherModal) teacherModal.style.display = 'none';
      });
    }
    // Form submit ve validasyonlar
    const teacherForm = document.getElementById('registerTeacherForm');
    const teacherPasswordError = document.getElementById('teacherPasswordError');
    const teacherEmailError = document.getElementById('teacherEmailError');
    const teacherRegisterError = document.getElementById('teacherRegisterError');
    const teacherPhoneError = document.getElementById('teacherPhoneError');
    teacherForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      teacherPasswordError.style.display = 'none';
      teacherEmailError.style.display = 'none';
      teacherRegisterError.style.display = 'none';
      teacherPhoneError.style.display = 'none';
      if (!teacherIti.isValidNumber()) {
        teacherPhoneError.style.display = 'block';
        return;
      }
      const password = teacherForm.teacherPassword.value;
      const confirmPassword = teacherForm.teacherConfirmPassword.value;
      if (password !== confirmPassword) {
        teacherPasswordError.style.display = 'block';
        return;
      }
      const data = {
        firstName: teacherForm.teacherFirstName.value,
        lastName: teacherForm.teacherLastName.value,
        phone: teacherIti.getNumber(),
        email: teacherForm.teacherEmail.value,
        password: password,
        salary: teacherForm.teacherSalary.value,
        socialSecurityNumber: teacherForm.teacherSSN.value,
        employmentType: teacherForm.teacherEmploymentType.value,
        categoryId: teacherForm.teacherCategoryId.value,
        startDate: teacherForm.teacherStartDate.value,
        endDate: teacherForm.teacherEndDate.value,
        experience: teacherForm.teacherExperience.value
      };
      try {
        const response = await fetch('/register_teacher', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await response.json();
        if (!response.ok) {
          if (result.error && result.error.toLowerCase().includes('email')) {
            teacherEmailError.style.display = 'block';
          } else {
            teacherRegisterError.textContent = result.error || 'Kayıt başarısız oldu.';
            teacherRegisterError.style.display = 'block';
          }
        } else {
          teacherModal.style.display = 'none';
          // window.location.href = '/register_success.html';
          // İsteğe bağlı: öğretmen listesini burada güncelleyebilirsiniz
        }
      } catch (err) {
        teacherRegisterError.textContent = 'Bağlantı hatası. Lütfen daha sonra tekrar deneyin.';
        teacherRegisterError.style.display = 'block';
      }
    });
    document.querySelectorAll('#teacherModal .togglePassword').forEach(button => {
      button.addEventListener('click', () => {
        const input = button.previousElementSibling;
        if (input.type === "password") {
          input.type = "text";
          button.textContent = "Gizle";
        } else {
          input.type = "password";
          button.textContent = "Göster";
        }
      });
    });

    async function loadStudentModalCategoriesAndLevels() {
      const catSelect = document.getElementById('categoryFilter');
      catSelect.innerHTML = '<option value="">Tümü</option>';
      try {
        const [catRes, levelRes] = await Promise.all([
          fetch('/api/categories', { credentials: 'include' }),
          fetch('/api/course-levels', { credentials: 'include' })
        ]);
        const cats = await catRes.json();
        const levels = await levelRes.json();
        if (cats.categories && cats.categories.length > 0) {
          cats.categories.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.Category_ID;
            opt.textContent = c.Category_Name;
            catSelect.appendChild(opt);
          });
        }
        const levelSelect = document.getElementById('levelFilter');
        levelSelect.innerHTML = '<option value="">Tümü</option>';
        levels.levels.forEach(lvl => {
          const opt = document.createElement('option');
          opt.value = lvl;
          opt.textContent = lvl;
          levelSelect.appendChild(opt);
        });
      } catch (err) {
        catSelect.innerHTML = '<option value="">Kategoriler yüklenemedi</option>';
        console.error('Kategoriler yüklenemedi:', err);
      }
    }

    if (openStudentModalBtn && studentModal && closeStudentModalBtn) {
      openStudentModalBtn.addEventListener('click', () => {
        document.querySelector('#studentModal h1').textContent = 'Öğrenci Kayıt Formu';
        form.reset();
        form.guardianId.value = '';
        form.guardianSearch.value = '';
        studentModal.style.display = 'flex';
        loadStudentModalCategoriesAndLevels(); // <-- Ensure categories are loaded every time
      });
      closeStudentModalBtn.addEventListener('click', () => {
        studentModal.style.display = 'none';
      });
      window.addEventListener('click', (e) => {
        if (e.target === studentModal) studentModal.style.display = 'none';
      });
    }

  </script>
</body>
</html>